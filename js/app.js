/* v3 - Insumos + Producción
 - Nueva página "insumos.html" con tabs Etiquetas/Latas
 - Formateo Última actualización AR: YYYY-MM-DD HH:MM (America/Argentina/Buenos_Aires)
 - Latas: sólo ingresos positivos, editar actualiza movimiento 'emptycans/add' (qty y descripción con emptyId/lot/provider)
 - Producción: selector de etiqueta muestra "Marca - Estilo/Custom - stock qty"; estado 'final' si etiquetada y pasteurizada
*/
const API_BASE = "https://script.google.com/macros/s/AKfycbxGfnvm8OXMnd-EuIyHGVL8ZdzvZEQH8R0GiG4hUhilwWltxZ5zYer7FQ-GIvAenfs/exec";
const TZ_AR = "America/Argentina/Buenos_Aires";

var Toast = window.Toast || Swal.mixin({toast:true,position:"top-end",showConfirmButton:false,timer:1700,timerProgressBar:true,didOpen:t=>{t.addEventListener("mouseenter",Swal.stopTimer);t.addEventListener("mouseleave",Swal.resumeTimer);}});
window.Toast = Toast;
function lockBtn(btn){if(!btn)return()=>{};const prev={d:btn.disabled,h:btn.innerHTML};btn.disabled=true;btn.innerHTML=`<span class="spinner-border spinner-border-sm"></span> ${btn.textContent||"Procesando…"}`;return()=>{btn.disabled=prev.d;btn.innerHTML=prev.h};}
async function withBtnLock(btn,fn){const u=lockBtn(btn);try{return await fn();}finally{u();}}
function confirmDelete(text="¿Eliminar este registro?"){return Swal.fire({icon:"warning",title:"Confirmar",text,showCancelButton:true,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar"});}

async function apiGet(entity,action="getAll",extra={}){const p=new URLSearchParams({entity,action,...extra});const r=await fetch(`${API_BASE}?${p.toString()}`);if(!r.ok)throw new Error(`GET ${entity}/${action} ${r.status}`);return r.json();}
async function apiPost(entity,data,action){const url=action?`${API_BASE}?entity=${entity}&action=${action}`:`${API_BASE}?entity=${entity}`;const r=await fetch(url,{method:"POST",body:JSON.stringify(data||{})});const j=await r.json();if(!r.ok||j.error)throw new Error(j.error||`POST ${entity}/${action||""} ${r.status}`);return j;}
async function apiDelete(entity,id){return apiPost(entity,{id},"delete");}

function initTheme(){const sw=document.getElementById("themeSwitch");const saved=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",saved);if(sw){sw.checked=saved==="dark";sw.addEventListener("change",()=>{const t=sw.checked?"dark":"light";document.documentElement.setAttribute("data-theme",t);localStorage.setItem("theme",t);});}}
function renderIdShort(id){return id?id.slice(0,8):""}
function renderColorSquare(c){return c?`<span class="color-box" style="background:${c}"></span>`:""}
function formatAR(iso){if(!iso)return"";try{const d=new Date(iso);const s=d.toLocaleString('sv-SE',{timeZone:TZ_AR,hour12:false});return s.slice(0,16);}catch(e){return iso;}}
function renderDateLocal(s){return formatAR(s);}
const nowInputDateTime=()=>{const d=new Date();const s=d.toLocaleString('sv-SE',{timeZone:TZ_AR,hour12:false});return s.slice(0,16).replace(" ","T");}
function fromDatetimeLocalValue(v){if(!v)return null;return v.replace("T"," ")+":00";}
function truncateIdsInDesc(txt){if(!txt)return"";let s=String(txt);s=s.replace(/\b(labelId|styleId|brandId|emptyId)=([0-9a-f]{8})[0-9a-f\-]*/gi,(_,k,p)=>`${k}=${p}`);s=s.replace(/usados:([0-9a-f\-:,]+)/gi,m=>{const list=m.split(":")[1]||"";const mapped=list.split(",").map(p=>{const[a,q]=p.split(":");return `${(a||"").slice(0,8)}:${q||""}`}).join(",");return`usados:${mapped}`});return s;}

/* ===== Movements ===== */
function renderMovementsTable(list){const tb=document.querySelector("#movementsTable tbody");if(!tb)return;tb.innerHTML="";for(const row of list){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(row.id)}</td><td>${renderDateLocal(row.dateTime)}</td><td>${row.entity||""}</td><td>${row.type||""}</td><td>${row.qty??0}</td><td>${truncateIdsInDesc(row.description||"")}</td><td>${renderDateLocal(row.lastModified)}</td>`;tb.appendChild(tr);}}
async function bootMovements(){try{const rows=await apiGet("movements");renderMovementsTable(rows);}catch(e){console.error(e);}}

/* ===== Producción + Empty Cans ===== */
async function loadProductionData(){const[styles,cans]=await Promise.all([apiGet("styles"),apiGet("cans")]);const byStyle=new Map();for(const s of styles)byStyle.set(String(s.id),{style:s,totals:{final:0,pasteurizada_sin_etiquetar:0,sin_pasteurizar_etiquetada:0,sin_pasteurizar_sin_etiquetar:0}});for(const c of cans){if(!byStyle.has(String(c.styleId)))continue;const acc=byStyle.get(String(c.styleId));const st=String(c.state||"");const q=Number(c.qty||0);if(acc.totals[st]!=null)acc.totals[st]+=q;}renderProductionTable(Array.from(byStyle.values()));}
function renderProductionTable(rows){const tb=document.querySelector("#prod_table tbody");if(!tb)return;tb.innerHTML="";for(const r of rows){const{style,totals}=r;const tr=document.createElement("tr");tr.innerHTML=`<td>${style.brandName||""}</td><td>${style.name||""}</td><td class="text-end">${totals.final}</td><td class="text-end">${totals.pasteurizada_sin_etiquetar}</td><td class="text-end">${totals.sin_pasteurizar_etiquetada}</td><td class="text-end">${totals.sin_pasteurizar_sin_etiquetar}</td><td>—</td><td class="text-nowrap"><button class="btn btn-sm btn-primary me-1" onclick="openRegisterProduction(this,'${style.id}')">Registrar</button><button class="btn btn-sm btn-outline-secondary" onclick="openTransition(this,'${style.id}')">Cambiar estado</button></td>`;tb.appendChild(tr);}}
async function openRegisterProduction(btn,styleId){await withBtnLock(btn,async()=>{try{const[brands,styles,labels]=await Promise.all([apiGet("brands"),apiGet("styles"),apiGet("labels")]);const brandMap=new Map(brands.map(b=>[String(b.id),b.name]));const styleMap=new Map(styles.map(s=>[String(s.id),s.name]));const style=styles.find(s=>String(s.id)===String(styleId))||styles[0];const styleOpts=styles.map(s=>`<option value="${s.id}" ${String(s.id)===String(styleId)?"selected":""}>${s.brandName} - ${s.name}</option>`).join("");const optStyle=labels.filter(l=>!l.isCustom&&l.styleId).map(l=>({id:l.id,txt:`${brandMap.get(String(l.brandId))||""} - ${styleMap.get(String(l.styleId))||""} - stock ${l.qty||0}`}));const optCustom=labels.filter(l=>!!l.isCustom).map(l=>({id:l.id,txt:`${brandMap.get(String(l.brandId))||""} - (custom ${l.name||""}) - stock ${l.qty||0}`}));const optStyleHtml=optStyle.map(o=>`<option value="${o.id}">${o.txt}</option>`).join("");const optCustomHtml=optCustom.map(o=>`<option value="${o.id}">${o.txt}</option>`).join("");const html=`<div class="mb-2"><label class="form-label fw-semibold">Estilo</label><select id="rp_style" class="form-select">${styleOpts}</select></div><div class="row g-2"><div class="col-sm-4"><label class="form-label fw-semibold">Cantidad</label><input id="rp_qty" type="number" class="form-control" value="24" min="1"></div><div class="col-sm-4"><label class="form-label fw-semibold">Fecha/hora</label><input id="rp_dt" type="datetime-local" class="form-control" value="${nowInputDateTime()}"></div></div><div class="form-check mt-2"><input class="form-check-input" type="checkbox" id="rp_labeled"><label class="form-check-label" for="rp_labeled">Etiquetada</label></div><div class="mb-2 d-none" id="rp_label_wrap"><label class="form-label fw-semibold">Etiqueta a consumir (opcional)</label><select id="rp_label" class="form-select"><option value="">(usar FIFO del estilo)</option><optgroup label="Del estilo">${optStyleHtml}</optgroup>${optCustomHtml?`<optgroup label="Personalizadas">${optCustomHtml}</optgroup>`:""}</select></div><div class="form-check mt-2"><input class="form-check-input" type="checkbox" id="rp_pasteurized"><label class="form-check-label" for="rp_pasteurized">Pasteurizada</label></div>`;const res=await Swal.fire({title:"Registrar producción",html,showCancelButton:true,focusConfirm:false,didOpen:()=>{const cb=document.getElementById("rp_labeled");const w=document.getElementById("rp_label_wrap");cb.addEventListener("change",()=>w.classList.toggle("d-none",!cb.checked));},preConfirm:()=>({styleId:document.getElementById("rp_style").value,qty:Math.max(1,Number(document.getElementById("rp_qty").value||0)),dateTime:fromDatetimeLocalValue(document.getElementById("rp_dt").value),labeled:document.getElementById("rp_labeled").checked,pasteurized:document.getElementById("rp_pasteurized").checked,labelId:document.getElementById("rp_label").value})});if(!res.isConfirmed)return;await apiPost("production",res.value,"produce");Toast.fire({icon:"success",title:"Producción registrada"});await loadProductionData();}catch(err){console.error(err);Swal.fire("Error",err.message||"No se pudo registrar la producción","error");}});}
async function openTransition(btn,styleId){await withBtnLock(btn,async()=>{try{const[styles,labels]=await Promise.all([apiGet("styles"),apiGet("labels")]);const style=styles.find(s=>String(s.id)===String(styleId))||styles[0];const optStyle=labels.filter(l=>!l.isCustom&&String(l.styleId)===String(style.id)).map(l=>`<option value="${l.id}">${l.styleName||style.name} - stock ${l.qty||0}</option>`).join("");const optCustom=labels.filter(l=>!!l.isCustom).map(l=>`<option value="${l.id}">(custom) ${l.name} - stock ${l.qty||0}</option>`).join("");const html=`<div class="mb-2"><b>${style.brandName} - ${style.name}</b></div><div class="row g-2"><div class="col-sm-4"><label class="form-label fw-semibold">Cantidad</label><input id="ts_qty" type="number" class="form-control" value="12" min="1"></div><div class="col-sm-4"><label class="form-label fw-semibold">Fecha/hora</label><input id="ts_dt" type="datetime-local" class="form-control" value="${nowInputDateTime()}"></div></div><div class="mb-2"><label class="form-label fw-semibold">Pasar a estado</label><select id="ts_to" class="form-select"><option value="final">Final (lista)</option><option value="pasteurizada_sin_etiquetar">Pasteurizada sin etiquetar</option><option value="sin_pasteurizar_etiquetada">Sin pasteurizar y etiquetada</option><option value="sin_pasteurizar_sin_etiquetar">Sin pasteurizar y sin etiquetar</option></select></div><div class="form-check mt-2"><input class="form-check-input" type="checkbox" id="ts_consume_labels"><label class="form-check-label" for="ts_consume_labels">Consumir etiquetas si el destino es etiquetado</label></div><div class="mb-2 d-none" id="ts_label_wrap"><label class="form-label fw-semibold">Etiqueta a consumir</label><select id="ts_label" class="form-select"><option value="">(usar FIFO del estilo)</option>${optStyle}${optCustom?`<optgroup label="Personalizadas">${optCustom}</optgroup>`:""}</select></div>`;const res=await Swal.fire({title:"Cambiar estado",html,showCancelButton:true,focusConfirm:false,didOpen:()=>{const cb=document.getElementById("ts_consume_labels");const wrap=document.getElementById("ts_label_wrap");const sel=document.getElementById("ts_to");function t(){const needs=/etiquetad/i.test(sel.value);wrap.classList.toggle("d-none",!needs||!cb.checked);}cb.addEventListener("change",t);sel.addEventListener("change",t);t();},preConfirm:()=>({qty:Math.max(1,Number(document.getElementById("ts_qty").value||0)),dateTime:fromDatetimeLocalValue(document.getElementById("ts_dt").value),toState:document.getElementById("ts_to").value,consumeLabels:document.getElementById("ts_consume_labels").checked,labelId:document.getElementById("ts_label").value})});if(!res.isConfirmed)return;const p=res.value;await apiPost("cans",{styleId,fromState:"",toState:p.toState,qty:p.qty,dateTime:p.dateTime,consumeLabels:p.consumeLabels,labelId:p.labelId},"transition_state");Toast.fire({icon:"success",title:"Estado actualizado"});await loadProductionData();}catch(err){console.error(err);Swal.fire("Error",err.message||"No se pudo cambiar el estado","error");}});}
async function openAddEmptyCans(btn){await withBtnLock(btn,async()=>{const html=`<div class="row g-2"><div class="col-sm-4"><label class="form-label fw-semibold">Cantidad</label><input id="ec_qty" type="number" class="form-control" value="24" min="1"></div><div class="col-sm-4"><label class="form-label fw-semibold">Fecha/hora</label><input id="ec_dt" type="datetime-local" class="form-control" value="${nowInputDateTime()}"></div></div><div class="row g-2 mt-1"><div class="col-sm-6"><label class="form-label fw-semibold">Proveedor (opcional)</label><input id="ec_provider" class="form-control"></div><div class="col-sm-6"><label class="form-label fw-semibold">Lote (opcional)</label><input id="ec_lot" class="form-control"></div></div>`;const res=await Swal.fire({title:"Ingresar latas vacías",html,showCancelButton:true,focusConfirm:false,preConfirm:()=>({qty:Math.max(1,Number(document.getElementById("ec_qty").value||0)),dateTime:fromDatetimeLocalValue(document.getElementById("ec_dt").value),provider:document.getElementById("ec_provider").value||"",lot:document.getElementById("ec_lot").value||""})});if(!res.isConfirmed)return;await apiPost("emptycans",res.value,"add");Toast.fire({icon:"success",title:"Ingreso registrado"});if(document.getElementById("emptyCansTable"))await loadInsumosCans();if(document.getElementById("prod_table"))await loadProductionData();});}
async function bootProduction(){await loadProductionData();document.getElementById("btnNewProduction")?.addEventListener("click",e=>openRegisterProduction(e.currentTarget));document.getElementById("btnAddEmptyCans")?.addEventListener("click",e=>openAddEmptyCans(e.currentTarget));}

/* ===== Config (keep from v2, not repeated here for brevity) ===== */
async function bootConfig(){/* reuse from previous build by requesting data */const[brands,containers,styles]=await Promise.all([apiGet("brands"),apiGet("containers"),apiGet("styles")]);const brandMap=new Map(brands.map(b=>[String(b.id),b]));function renderBrands(){const tb=document.querySelector("#brandsTable tbody");if(!tb)return;tb.innerHTML="";for(const b of brands){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(b.id)}</td><td>${b.name}</td><td>${renderColorSquare(b.color)}</td><td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary me-1" data-id="${b.id}" data-ent="brands">Editar</button><button class="btn btn-sm btn-danger" data-id="${b.id}" data-ent="brands">Eliminar</button></td>`;tb.appendChild(tr);}tb.addEventListener("click",async e=>{const btn=e.target.closest("button");if(!btn)return;const id=btn.dataset.id,ent=btn.dataset.ent;if(btn.classList.contains("btn-danger")){await withBtnLock(btn,async()=>{const labels=await apiGet("labels");const stylesCur=await apiGet("styles");const styleIds=new Set(stylesCur.filter(s=>String(s.brandId)===String(id)).map(s=>String(s.id)));const blocked=labels.some(l=>String(l.brandId)===String(id)||styleIds.has(String(l.styleId)));if(blocked){Swal.fire("No permitido","No se puede eliminar la marca: tiene etiquetas asociadas.","info");return;}const ok=await confirmDelete("¿Eliminar la marca seleccionada?");if(!ok.isConfirmed)return;await apiDelete(ent,id);Toast.fire({icon:"success",title:"Eliminado"});location.reload();});}else{await withBtnLock(btn,async()=>{const b=brands.find(x=>String(x.id)===String(id));const html=`<div class="mb-2"><label class="form-label fw-semibold">Nombre</label><input id="brandName" class="form-control" value="${b.name||""}"></div><div class="mb-2 text-center"><label class="form-label fw-semibold d-block">Color</label><input id="brandColor" type="color" class="form-control form-control-color mx-auto" value="${b.color||"#000000"}"></div>`;const{value,isConfirmed}=await Swal.fire({title:"Editar marca",html,showCancelButton:true,preConfirm:()=>({name:document.getElementById("brandName").value,color:document.getElementById("brandColor").value})});if(!isConfirmed)return;await apiPost("brands",{id,...value},"update");Toast.fire({icon:"success",title:"Guardado"});location.reload();});}});}
function renderContainers(){const tb=document.querySelector("#containersTable tbody");if(!tb)return;tb.innerHTML="";for(const c of containers){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(c.id)}</td><td>${c.name}</td><td>${c.sizeLiters||""}</td><td>${c.type||""}</td><td>${renderColorSquare(c.color)}</td><td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary me-1" data-id="${c.id}" data-ent="containers">Editar</button><button class="btn btn-sm btn-danger" data-id="${c.id}" data-ent="containers">Eliminar</button></td>`;tb.appendChild(tr);}tb.addEventListener("click",async e=>{const btn=e.target.closest("button");if(!btn)return;const id=btn.dataset.id,ent=btn.dataset.ent;if(btn.classList.contains("btn-danger")){await withBtnLock(btn,async()=>{const ok=await confirmDelete("¿Eliminar el envase seleccionado?");if(!ok.isConfirmed)return;await apiDelete(ent,id);Toast.fire({icon:"success",title:"Eliminado"});location.reload();});}else{await withBtnLock(btn,async()=>{const c=containers.find(x=>String(x.id)===String(id));const html=`<div class="mb-2"><label class="form-label fw-semibold">Nombre</label><input id="containerName" class="form-control" value="${c.name||""}"></div><div class="mb-2"><label class="form-label fw-semibold">Tamaño (L)</label><input id="containerSize" type="number" class="form-control" value="${c.sizeLiters||0}"></div><div class="mb-2"><label class="form-label fw-semibold">Tipo</label><select id="containerType" class="form-select"><option value="lata" selected>Lata</option></select></div><div class="mb-2 text-center"><label class="form-label fw-semibold d-block">Color</label><input id="containerColor" type="color" class="form-control form-control-color mx-auto" value="${c.color||"#000000"}"></div>`;const{value,isConfirmed}=await Swal.fire({title:"Editar envase",html,showCancelButton:true,preConfirm:()=>({name:document.getElementById("containerName").value,sizeLiters:Number(document.getElementById("containerSize").value||0),type:document.getElementById("containerType").value,color:document.getElementById("containerColor").value})});if(!isConfirmed)return;await apiPost("containers",{id,...value},"update");Toast.fire({icon:"success",title:"Guardado"});location.reload();});}});}
function renderStyles(){const tb=document.querySelector("#stylesTable tbody");if(!tb)return;tb.innerHTML="";for(const s of styles){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(s.id)}</td><td>${brandMap.get(String(s.brandId))?.name||""}</td><td>${s.name}</td><td>${renderColorSquare(s.color)}</td><td>${s.showAlways?"Sí":"No"}</td><td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary me-1" data-id="${s.id}" data-ent="styles">Editar</button><button class="btn btn-sm btn-danger" data-id="${s.id}" data-ent="styles">Eliminar</button></td>`;tb.appendChild(tr);}}
renderBrands();renderContainers();renderStyles();}

/* ===== Etiquetas (igual que v2 con formato fecha AR) + Latas (nuevo) ===== */
function labelModalBody(brands,styles,d={}){const brandOpts=brands.map(b=>`<option value="${b.id}" ${String(b.id)===String(d.brandId)?"selected":""}>${b.name}</option>`).join("");const styleOpts=styles.map(s=>`<option value="${s.id}" ${String(s.id)===String(d.styleId)?"selected":""}>${s.name}</option>`).join("");return`<div class="mb-2"><label class="form-label fw-semibold">Marca</label><select id="lblBrandId" class="form-select" required>${brandOpts}</select></div><div class="form-check mt-1 mb-2"><input class="form-check-input" type="checkbox" id="lblIsCustom" ${d.isCustom?"checked":""}><label class="form-check-label fw-semibold" for="lblIsCustom">Es personalizada</label></div><div class="row g-2"><div class="col-sm-6"><label class="form-label fw-semibold">Estilo</label><select id="lblStyleId" class="form-select">${styleOpts}</select></div><div class="col-sm-6"><label class="form-label fw-semibold">Nombre (personalizado)</label><input id="lblName" class="form-control" value="${d.name||""}" placeholder="Solo si es personalizada"></div></div><div class="row g-2 mt-1"><div class="col-sm-3"><label class="form-label fw-semibold">Cantidad</label><input id="lblQty" type="number" class="form-control" value="${d.qty||0}" min="0"></div><div class="col-sm-3"><label class="form-label fw-semibold">Fecha/hora</label><input id="lblDt" type="datetime-local" class="form-control" value="${nowInputDateTime()}"></div><div class="col-sm-3"><label class="form-label fw-semibold">Proveedor</label><input id="lblProvider" class="form-control" value="${d.provider||""}"></div><div class="col-sm-3"><label class="form-label fw-semibold">Lote</label><input id="lblLot" class="form-control" value="${d.lot||""}"></div></div>`}
function hookLabelModalToggle(){const brandSel=document.getElementById("lblBrandId");const isCustomCb=document.getElementById("lblIsCustom");const styleSel=document.getElementById("lblStyleId");const nameInp=document.getElementById("lblName");function apply(){const hasBrand=!!brandSel.value;isCustomCb.disabled=!hasBrand;if(!hasBrand){styleSel.disabled=true;nameInp.disabled=true;return;}const custom=isCustomCb.checked;styleSel.disabled=custom;nameInp.disabled=!custom;}brandSel.addEventListener("change",apply);isCustomCb.addEventListener("change",apply);apply();}
function collectLabelPayload(){const brandId=document.getElementById("lblBrandId").value;if(!brandId){Swal.showValidationMessage("Primero seleccione la Marca.");return null;}const custom=document.getElementById("lblIsCustom").checked;const styleSel=document.getElementById("lblStyleId");const nameInp=document.getElementById("lblName");if(!custom && !styleSel.value){Swal.showValidationMessage("Seleccione un Estilo (o marque 'Es personalizada').");return null;}if(custom){/* nombre opcional */}else{ if(nameInp.value){Swal.showValidationMessage("Nombre personalizado solo si es 'Es personalizada'.");return null;} }const qty=Number(document.getElementById("lblQty").value||0);if(qty<0){Swal.showValidationMessage("Cantidad inválida.");return null;}return{brandId,styleId:custom?"":styleSel.value,name:custom?nameInp.value:"",qty,dateTime:fromDatetimeLocalValue(document.getElementById("lblDt").value),provider:document.getElementById("lblProvider").value,lot:document.getElementById("lblLot").value,isCustom:custom};}

function emptyCansModalBody(d={}){return`<div class="row g-2"><div class="col-sm-4"><label class="form-label fw-semibold">Cantidad</label><input id="ec_qty" type="number" class="form-control" value="${d.qty??24}" min="1"></div><div class="col-sm-4"><label class="form-label fw-semibold">Fecha/hora</label><input id="ec_dt" type="datetime-local" class="form-control" value="${nowInputDateTime()}"></div></div><div class="row g-2 mt-1"><div class="col-sm-6"><label class="form-label fw-semibold">Proveedor (opcional)</label><input id="ec_provider" class="form-control" value="${d.provider||""}"></div><div class="col-sm-6"><label class="form-label fw-semibold">Lote (opcional)</label><input id="ec_lot" class="form-control" value="${d.lot||""}"></div></div>`}
function collectEmptyCansPayload(){const qty=Math.max(1,Number(document.getElementById("ec_qty").value||0));const dateTime=fromDatetimeLocalValue(document.getElementById("ec_dt").value);const provider=document.getElementById("ec_provider").value||"";const lot=document.getElementById("ec_lot").value||"";return{qty,dateTime,provider,lot};}

async function loadInsumosLabels(){const[brands,styles]=await Promise.all([apiGet("brands"),apiGet("styles")]);let labels=await apiGet("labels");const brandMap=new Map(brands.map(b=>[String(b.id),b]));const styleMap=new Map(styles.map(s=>[String(s.id),s]));const tbody=document.querySelector("#labelsTable tbody");if(!tbody)return;function refreshCards(){document.getElementById("lbl_total_units").textContent=labels.reduce((a,x)=>a+Number(x.qty||0),0);document.getElementById("lbl_total_items").textContent=labels.length;const last=labels.reduce((m,x)=>!m||new Date(x.lastModified)>new Date(m)?x.lastModified:m,null);document.getElementById("lbl_last_mod").textContent=last?formatAR(last):"—";}
function render(){tbody.innerHTML="";for(const l of labels){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(l.id)}</td><td>${brandMap.get(String(l.brandId))?.name||""}</td><td>${l.isCustom?(l.name||"custom"):(styleMap.get(String(l.styleId))?.name||"")}</td><td>${l.qty||0}</td><td>${l.lot||""}</td><td>${l.provider||""}</td><td>${renderDateLocal(l.dateTime)}</td><td>${renderDateLocal(l.lastModified)}</td><td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary me-1" data-id="${l.id}">Editar</button><button class="btn btn-sm btn-danger" data-id="${l.id}">Eliminar</button></td>`;tbody.appendChild(tr);}refreshCards();}
render();
document.getElementById("btnAddLabel")?.addEventListener("click",e=>withBtnLock(e.currentTarget,async()=>{const{value,isConfirmed}=await Swal.fire({title:"Agregar etiqueta",html:labelModalBody(brands,styles,{}),showCancelButton:true,focusConfirm:false,didOpen:hookLabelModalToggle,preConfirm:collectLabelPayload});if(!isConfirmed||!value)return;await apiPost("labels",value,"create");labels=await apiGet("labels");render();Toast.fire({icon:"success",title:"Agregado"});}));
tbody.addEventListener("click",async e=>{const btn=e.target.closest("button");if(!btn)return;const id=btn.dataset.id;if(btn.classList.contains("btn-danger")){await withBtnLock(btn,async()=>{const ok=await confirmDelete("¿Eliminar la etiqueta seleccionada?");if(!ok.isConfirmed)return;await apiDelete("labels",id);labels=await apiGet("labels");render();Toast.fire({icon:"success",title:"Eliminada"});});}else{await withBtnLock(btn,async()=>{const l=(await apiGet("labels")).find(x=>String(x.id)===String(id));const{value,isConfirmed}=await Swal.fire({title:"Editar etiqueta",html:labelModalBody(brands,styles,l),showCancelButton:true,focusConfirm:false,didOpen:hookLabelModalToggle,preConfirm:collectLabelPayload});if(!isConfirmed||!value)return;await apiPost("labels",{id,...value},"update");labels=await apiGet("labels");render();Toast.fire({icon:"success",title:"Guardado"});});}});}

async function loadInsumosCans(){let cans=await apiGet("emptycans");const tbody=document.querySelector("#emptyCansTable tbody");if(!tbody)return;const positives=cans.filter(c=>Number(c.qty||0)>0);function refreshCards(){document.getElementById("can_total_units").textContent=positives.reduce((a,x)=>a+Number(x.qty||0),0);document.getElementById("can_total_items").textContent=positives.length;const last=positives.reduce((m,x)=>!m||new Date(x.lastModified)>new Date(m)?x.lastModified:m,null);document.getElementById("can_last_mod").textContent=last?formatAR(last):"—";}
function render(){tbody.innerHTML="";for(const c of positives){const tr=document.createElement("tr");tr.innerHTML=`<td>${renderIdShort(c.id)}</td><td>${c.qty||0}</td><td>${c.lot||""}</td><td>${c.provider||""}</td><td>${renderDateLocal(c.dateTime)}</td><td>${renderDateLocal(c.lastModified)}</td><td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary" data-id="${c.id}">Editar</button></td>`;tbody.appendChild(tr);}refreshCards();}
render();
document.getElementById("btnAddEmptyCans_insumos")?.addEventListener("click",e=>withBtnLock(e.currentTarget,async()=>{const{value,isConfirmed}=await Swal.fire({title:"Ingresar latas vacías",html:emptyCansModalBody({}),showCancelButton:true,preConfirm:collectEmptyCansPayload});if(!isConfirmed||!value)return;await apiPost("emptycans",value,"add");await loadInsumosCans();Toast.fire({icon:"success",title:"Ingreso registrado"});}));
tbody.addEventListener("click",async e=>{const btn=e.target.closest("button");if(!btn)return;const id=btn.dataset.id;await withBtnLock(btn,async()=>{const cur=(await apiGet("emptycans")).find(x=>String(x.id)===String(id));const{value,isConfirmed}=await Swal.fire({title:"Editar lote de latas",html:emptyCansModalBody(cur),showCancelButton:true,preConfirm:collectEmptyCansPayload});if(!isConfirmed||!value)return;await apiPost("emptycans",{id,...value},"update");await loadInsumosCans();Toast.fire({icon:"success",title:"Guardado"});});});}

async function loadInsumosPage(){await loadInsumosLabels();await loadInsumosCans();}

async function boot(){initTheme();if(document.getElementById("movementsTable"))await bootMovements();if(document.getElementById("prod_table"))await bootProduction();if(document.getElementById("brandsTable"))await bootConfig();if(document.querySelector("#tab-labels")||document.querySelector("#tab-cans"))await loadInsumosPage();if(document.getElementById("idx_chart_styles")){try{const[styles,cans,emptycans,labels]=await Promise.all([apiGet("styles"),apiGet("cans"),apiGet("emptycans"),apiGet("labels")]);const sumByStyle=new Map(styles.map(s=>[String(s.id),0]));for(const c of cans){sumByStyle.set(String(c.styleId),(sumByStyle.get(String(c.styleId))||0)+Number(c.qty||0));}const names=[],qtys=[];for(const s of styles){const tot=sumByStyle.get(String(s.id))||0;if(s.showAlways||tot>0){names.push(`${s.brandName}-${s.name}`);qtys.push(tot);}}document.getElementById("idx_total_cans").textContent=cans.reduce((a,x)=>a+Number(x.qty||0),0);document.getElementById("idx_total_emptycans").textContent=emptycans.reduce((a,x)=>a+Number(x.qty||0),0);document.getElementById("idx_total_labels").textContent=labels.reduce((a,x)=>a+Number(x.qty||0),0);if(window.Chart){const ctx=document.getElementById("idx_chart_styles");if(ctx)new Chart(ctx,{type:"bar",data:{labels:names,datasets:[{label:"Stock de latas por estilo",data:qtys}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});const ctx2=document.getElementById("idx_chart_labels");if(ctx2){const totals=new Map(styles.map(s=>[String(s.id),0]));for(const l of labels){if(!l.isCustom)totals.set(String(l.styleId),(totals.get(String(l.styleId))||0)+Number(l.qty||0));}const n2=[],q2=[];for(const s of styles){const t=totals.get(String(s.id))||0;if(s.showAlways||t>0){n2.push(`${s.brandName}-${s.name}`);q2.push(t);}}new Chart(ctx2,{type:"bar",data:{labels:n2,datasets:[{label:"Etiquetas disponibles",data:q2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}})}}}catch(e){console.error(e);}}}
if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",boot);else boot();
