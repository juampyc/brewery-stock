<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Castelo | Producción</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script>window.APP_VER = "20250911a";</script>
  <script src="./js/app-loader.js?v=1" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
</head>
<body>
<header class="border-bottom bg-body px-3 py-2 d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-2">
    <span class="fw-bold">Castelo</span>
    <a class="btn btn-link p-0" href="index.html">Inicio</a>
    <a class="btn btn-link p-0" href="config.html">Configuración</a>
    <a class="btn btn-link p-0" href="labels.html">Etiquetas</a>
    <a class="btn btn-link p-0" href="movements.html">Movimientos</a>
    <a class="btn btn-link p-0" href="production.html">Producción</a>
  </div>
  <div class="form-check form-switch m-0">
    <input class="form-check-input" type="checkbox" id="themeSwitch" />
    <label class="form-check-label" for="themeSwitch">Dark</label>
  </div>
</header>

<main class="container py-3">
  <h1 class="h4 mb-3">Registrar producción</h1>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-sm-4">
          <label class="form-label mb-1">Estilo</label>
          <select id="prod_style" class="form-select"></select>
        </div>
        <div class="col-sm-3">
          <label class="form-label mb-1">Envase</label>
          <select id="prod_container" class="form-select"></select>
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-1">Cantidad (latas)</label>
          <input id="prod_qty" type="number" class="form-control" min="1" value="24" />
        </div>
        <div class="col-sm-3">
          <label class="form-label mb-1">Fecha y hora</label>
          <input id="prod_dt" type="datetime-local" class="form-control" />
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-sm-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="prod_labeled" />
            <label class="form-check-label" for="prod_labeled">Etiquetada</label>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="prod_pasteurized" />
            <label class="form-check-label" for="prod_pasteurized">Pasteurizada</label>
          </div>
        </div>
      </div>

      <div id="label_picker_wrap" class="row g-3 mt-1 d-none">
        <div class="col-sm-6">
          <label class="form-label mb-1">Etiqueta a usar (opcional)</label>
          <select id="prod_label" class="form-select">
            <option value="">(Por estilo)</option>
          </select>
          <div class="form-text">Por defecto consume etiquetas del mismo estilo; podés elegir una personalizada.</div>
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button id="prod_submit" class="btn btn-primary">Registrar producción</button>
        <button id="prod_refresh" class="btn btn-outline-secondary">Refrescar stock</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h6 class="card-title">Stock de latas por estado</h6>
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0" id="cans_stock_table">
          <thead><tr><th>Estilo</th><th>Estado</th><th>Etiqueta</th><th class="text-end">Cantidad</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script>
(function(){
  const prodStyle = document.getElementById('prod_style');
  const prodContainer = document.getElementById('prod_container');
  const prodQty = document.getElementById('prod_qty');
  const prodDt = document.getElementById('prod_dt');
  const prodLabeled = document.getElementById('prod_labeled');
  const prodPasteurized = document.getElementById('prod_pasteurized');
  const prodLabel = document.getElementById('prod_label');
  const labelWrap = document.getElementById('label_picker_wrap');
  const btnSubmit = document.getElementById('prod_submit');
  const btnRefresh = document.getElementById('prod_refresh');
  const cansTbody = document.querySelector('#cans_stock_table tbody');

  function nowLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  async function loadStyles(){
    const styles = await apiGet('styles');
    // showAlways or have stock we'll show anyway; but for production we list all styles
    prodStyle.innerHTML = styles.map(s=>`<option value="\${s.id}" data-brand="\${s.brandName}">\${s.brandName||''} - \${s.name}</option>`).join('');
    rebuildLabels();
  }

  async function loadContainers(){
    const all = await apiGet('containers');
    const filtered = all.filter(c => (String(c.type||'lata').toLowerCase() === 'lata' || String(c.type||'').toLowerCase() === 'barril'));
    prodContainer.innerHTML = filtered.map(c=>`<option value="\${c.id}" data-type="\${c.type}">\${c.name} (\${c.type||'lata'})</option>`).join('');
  }

  let labelsCache = [];
  async function loadLabelsCache(){
    labelsCache = await apiGet('labels');
  }
  function rebuildLabels(){
    const styleId = prodStyle.value;
    const rel = labelsCache.filter(l => !l.isCustom && String(l.styleId) === String(styleId));
    const customs = labelsCache.filter(l => !!l.isCustom);
    prodLabel.innerHTML = '<option value="">(Por estilo)</option>'
      + rel.map(l => `<option value="\${l.id}">\${l.brandName||''} - \${l.styleName}</option>`).join('')
      + (customs.length? '<optgroup label="Personalizadas">':'')
      + customs.map(l => `<option value="\${l.id}">(custom) \${l.name}</option>`).join('')
      + (customs.length? '</optgroup>':'');
  }

  function setLabelVisibility(){
    labelWrap.classList.toggle('d-none', !prodLabeled.checked);
  }

  async function refreshStock(){
    const stock = await apiGet('cans', 'getAll'); // stock table uses 'cans' sheet
    const styles = await apiGet('styles');
    const byId = Object.fromEntries(styles.map(s=>[String(s.id), s]));
    cansTbody.innerHTML='';
    stock.sort((a,b)=> (byId[a.styleId]?.brandName||'').localeCompare(byId[b.styleId]?.brandName||'') || (byId[a.styleId]?.name||'').localeCompare(byId[b.styleId]?.name||'') || String(a.state).localeCompare(String(b.state)) );
    stock.forEach(r=>{
      const s = byId[String(r.styleId)] || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>\${(s.brandName||'')+' - '+(s.name||'')}</td><td>\${r.state||''}</td><td>\${r.labelName||''}</td><td class="text-end">\${r.qty||0}</td>`;
      cansTbody.appendChild(tr);
    });
  }

  btnSubmit.addEventListener('click', async ()=>{
    try{
      btnSubmit.disabled = true;
      const payload = {
        styleId: prodStyle.value,
        containerId: prodContainer.value,
        qty: Math.max(1, Number(prodQty.value||0)),
        labeled: prodLabeled.checked,
        pasteurized: prodPasteurized.checked,
        labelId: prodLabeled.checked ? (prodLabel.value||'') : '',
        dateTime: prodDt.value
      };
      const res = await apiPost('production', payload, 'register_production');
      if (!res.ok) throw new Error(res.error || 'No se pudo registrar producción');
      Toast.fire({ icon:'success', title:'Producción registrada' });
      await refreshStock();
    } catch(e){
      console.error(e);
      Swal.fire('Error', e.message || 'No se pudo registrar producción', 'error');
    } finally {
      btnSubmit.disabled = false;
    }
  });

  btnRefresh.addEventListener('click', refreshStock);
  prodStyle.addEventListener('change', rebuildLabels);
  prodLabeled.addEventListener('change', setLabelVisibility);

  prodDt.value = nowLocal();
  loadStyles();
  loadContainers();
  loadLabelsCache().then(rebuildLabels);
  refreshStock();
  setLabelVisibility();
})();
</script>
</body>
</html>
