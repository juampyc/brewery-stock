<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Castelo | Empaquetado / Stock</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Versionado para cache-busting -->
  <script>window.APP_VER = "20250910a";</script>

  <!-- Librerías primero -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- Tu loader (inyecta styles.css, theme-checker.js y app.js con ?v=APP_VER) -->
  <script src="./js/app-loader.js?v=1" defer></script>
</head>
<body>
  <!-- Top nav -->
  <header class="border-bottom bg-body px-3 py-2 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <span class="fw-bold">Castelo</span>
      <a class="btn btn-link p-0" href="index.html">Inicio</a>
      <a class="btn btn-link p-0" href="config.html">Configuración</a>
      <a class="btn btn-link p-0" href="labels.html">Etiquetas</a>
      <a class="btn btn-link p-0" href="movements.html">Movimientos</a>
      <a class="btn btn-link p-0" href="packaging.html">Empaquetado</a>
    </div>
    <div class="form-check form-switch m-0">
      <input class="form-check-input" type="checkbox" id="themeSwitch" />
      <label class="form-check-label" for="themeSwitch">Dark</label>
    </div>
  </header>

  <main class="container py-3">
    <h1 class="h4 mb-3">Empaquetado / Stock</h1>

    <!-- Filtros -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Marca</label>
            <select id="pk_filter_brand" class="form-select">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">Estilo</label>
            <select id="pk_filter_style" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-12 col-md-4 text-md-end">
            <button id="pk_btn_refresh" class="btn btn-primary mt-3 mt-md-0">Actualizar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen en cards -->
    <div class="row g-3" id="pk_cards_row">
      <!-- Se llena por JS -->
    </div>

    <!-- Tablas -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-xl-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Stock de latas (por estilo y estado)</span>
            <button id="pk_cans_csv" class="btn btn-sm btn-outline-secondary">CSV</button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0" id="pk_cans_table">
                <thead>
                  <tr>
                    <th>Marca</th><th>Estilo</th><th>Estado</th><th class="text-end">Latas</th>
                  </tr>
                </thead>
                <tbody><!-- JS --></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Total</th>
                    <th class="text-end" id="pk_cans_total">0</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Stock de paquetes (por estilo y tipo)</span>
            <button id="pk_packages_csv" class="btn btn-sm btn-outline-secondary">CSV</button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0" id="pk_packages_table">
                <thead>
                  <tr>
                    <th>Marca</th><th>Estilo</th><th>Tipo</th><th class="text-end">Cajas</th><th class="text-end">Latas</th>
                  </tr>
                </thead>
                <tbody><!-- JS --></tbody>
                <tfoot>
                  <tr>
                    <th colspan="3" class="text-end">Total</th>
                    <th class="text-end" id="pk_boxes_total">0</th>
                    <th class="text-end" id="pk_boxes_cans_total">0</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- ======== Script de página (usa apiGet de app.js) ======== -->
  <script>
  (function(){
    // Data cache local
    let BRANDS = [], STYLES = [], CANS = [], PACKS = [];

    // Helpers
    const byId = (id) => document.getElementById(id);
    const fmtInt = (n) => (Number(n)||0).toLocaleString();

    function friendlyType(t){
      return String(t)==="box24" ? "Caja x24" : "Caja x12";
    }
    function stateBadge(state){
      const map = {
        "final": "success",
        "pasteurizada_sin_etiquetar": "primary",
        "sin_pasteurizar_etiquetada": "warning",
        "sin_pasteurizar_sin_etiquetar": "secondary"
      };
      const cls = map[state] || "dark";
      return `<span class="badge bg-${cls}">${state.replaceAll("_"," ")}</span>`;
    }

    // Filtros
    function loadFilters(){
      const selB = byId("pk_filter_brand");
      const selS = byId("pk_filter_style");
      selB.innerHTML = `<option value="">Todas</option>` + BRANDS
        .map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
      selS.innerHTML = `<option value="">Todos</option>` + STYLES
        .map(s=>`<option value="${s.id}" data-brand="${s.brandId}">${s.name}</option>`).join("");

      // Vincular estilo a marca
      selB.addEventListener("change", ()=>{
        const bid = selB.value;
        const opts = STYLES
          .filter(s => !bid || String(s.brandId)===String(bid))
          .map(s=>`<option value="${s.id}">${s.name}</option>`).join("");
        selS.innerHTML = `<option value="">Todos</option>` + opts;
      });
    }

    // Agregaciones
    function aggregateCans(){
      // key: styleId|state
      const map = new Map();
      for (const c of CANS){
        const key = [c.styleId, c.state].join("|");
        const prev = map.get(key) || { styleId:c.styleId, state:c.state, qty:0 };
        prev.qty += Number(c.qty||0);
        map.set(key, prev);
      }
      return Array.from(map.values());
    }

    function aggregatePackages(){
      // key: styleId|type  (sumo cajas y latas, ignorando labelId)
      const map = new Map();
      for (const p of PACKS){
        const key = [p.styleId, p.type].join("|");
        const prev = map.get(key) || { styleId:p.styleId, type:p.type, boxes:0, qtyCans:0 };
        prev.boxes   += Number(p.boxes||0);
        prev.qtyCans += Number(p.qtyCans||0);
        map.set(key, prev);
      }
      return Array.from(map.values());
    }

    // Render: CARDS
    function renderCards(){
      const row = byId("pk_cards_row");
      row.innerHTML = "";

      // Construyo por estilo
      // cansByStyle: styleId -> {total, porEstado}
      const cansAgg = aggregateCans();
      const byStyle = new Map();
      for (const a of cansAgg){
        const st = byStyle.get(a.styleId) || { total:0, estados:{} };
        st.total += Number(a.qty||0);
        st.estados[a.state] = (st.estados[a.state]||0) + Number(a.qty||0);
        byStyle.set(a.styleId, st);
      }

      // packages por estilo
      const packAgg = aggregatePackages();
      const pkByStyle = new Map();
      for (const a of packAgg){
        const st = pkByStyle.get(a.styleId) || { box12: {boxes:0,cans:0}, box24:{boxes:0,cans:0} };
        if (String(a.type)==="box24"){
          st.box24.boxes += Number(a.boxes||0);
          st.box24.cans  += Number(a.qtyCans||0);
        } else {
          st.box12.boxes += Number(a.boxes||0);
          st.box12.cans  += Number(a.qtyCans||0);
        }
        pkByStyle.set(a.styleId, st);
      }

      // Filtros
      const fBrand = byId("pk_filter_brand").value;
      const fStyle = byId("pk_filter_style").value;

      // Armado de cards por estilo que cumpla filtros y tenga algo
      const styles = STYLES.filter(s => {
        if (fBrand && String(s.brandId)!==String(fBrand)) return false;
        if (fStyle && String(s.id)!==String(fStyle)) return false;
        const hasCans = byStyle.has(s.id);
        const hasPacks = pkByStyle.has(s.id);
        return hasCans || hasPacks;
      });

      // Orden por total de latas (desc)
      styles.sort((a,b)=>{
        const ta = byStyle.get(a.id)?.total || 0;
        const tb = byStyle.get(b.id)?.total || 0;
        return tb - ta;
      });

      for (const s of styles){
        const brand = BRANDS.find(b => String(b.id)===String(s.brandId));
        const stC = byStyle.get(s.id) || { total:0, estados:{} };
        const stP = pkByStyle.get(s.id) || { box12:{boxes:0,cans:0}, box24:{boxes:0,cans:0} };

        const estadosHtml = Object.entries(stC.estados)
          .sort((a,b)=>b[1]-a[1])
          .map(([state, qty]) => `
            <div class="d-flex justify-content-between align-items-center">
              <div>${stateBadge(state)}</div>
              <div class="fw-semibold">${fmtInt(qty)}</div>
            </div>
          `).join("") || `<div class="text-muted small">Sin latas registradas</div>`;

        const packsHtml = `
          <div class="d-flex justify-content-between"><span class="badge bg-dark">Caja x12</span><span class="fw-semibold">${fmtInt(stP.box12.boxes)} cajas</span></div>
          <div class="d-flex justify-content-between"><span class="badge bg-dark">Caja x24</span><span class="fw-semibold">${fmtInt(stP.box24.boxes)} cajas</span></div>
          <div class="border-top pt-1 mt-1 d-flex justify-content-between text-muted">
            <span>Latas en paquetes</span><span>${fmtInt(stP.box12.cans + stP.box24.cans)}</span>
          </div>
        `;

        const col = document.createElement("div");
        col.className = "col-12 col-md-6 col-xxl-4";
        col.innerHTML = `
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <div>
                  <div class="text-muted small">${brand?.name || "Marca"}</div>
                  <div class="h6 mb-0">${s.name}</div>
                </div>
                <div class="text-end">
                  <div class="text-muted small">Latas</div>
                  <div class="h5 mb-0">${fmtInt(stC.total)}</div>
                </div>
              </div>

              <div class="row g-2">
                <div class="col-12 col-lg-6">
                  <div class="border rounded p-2">
                    <div class="small text-muted mb-1">Por estado</div>
                    ${estadosHtml}
                  </div>
                </div>
                <div class="col-12 col-lg-6">
                  <div class="border rounded p-2">
                    <div class="small text-muted mb-1">Paquetes</div>
                    ${packsHtml}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        row.appendChild(col);
      }

      if (row.children.length === 0){
        row.innerHTML = `<div class="col"><div class="alert alert-light border">No hay stock para los filtros seleccionados.</div></div>`;
      }
    }

    // Render: TABLAS
    function renderTables(){
      // CANS
      const cansAgg = aggregateCans()
        .map(a=>{
          const st = STYLES.find(s=>String(s.id)===String(a.styleId));
          const br = BRANDS.find(b=>String(b.id)===String(st?.brandId||""));
          return {
            brandName: br?.name || "",
            styleName: st?.name || "",
            styleId: a.styleId,
            state: a.state,
            qty: Number(a.qty||0)
          };
        });

      // filtros
      const fBrand = byId("pk_filter_brand").value;
      const fStyle = byId("pk_filter_style").value;
      const cansFilt = cansAgg.filter(r=>{
        if (fBrand){
          const st = STYLES.find(s=>String(s.id)===String(r.styleId));
          if (!st || String(st.brandId)!==String(fBrand)) return false;
        }
        if (fStyle && String(r.styleId)!==String(fStyle)) return false;
        return true;
      });

      cansFilt.sort((a,b)=>{
        if (a.brandName!==b.brandName) return a.brandName.localeCompare(b.brandName);
        if (a.styleName!==b.styleName) return a.styleName.localeCompare(b.styleName);
        return a.state.localeCompare(b.state);
      });

      const tbC = byId("pk_cans_table").querySelector("tbody");
      tbC.innerHTML = "";
      let totalCans = 0;
      for (const r of cansFilt){
        totalCans += r.qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.brandName}</td>
          <td>${r.styleName}</td>
          <td>${r.state.replaceAll("_"," ")}</td>
          <td class="text-end">${fmtInt(r.qty)}</td>
        `;
        tbC.appendChild(tr);
      }
      byId("pk_cans_total").textContent = fmtInt(totalCans);

      // PACKAGES
      const pkAgg = aggregatePackages()
        .map(a=>{
          const st = STYLES.find(s=>String(s.id)===String(a.styleId));
          const br = BRANDS.find(b=>String(b.id)===String(st?.brandId||""));
          return {
            brandName: br?.name || "",
            styleName: st?.name || "",
            styleId: a.styleId,
            type: a.type,
            boxes: Number(a.boxes||0),
            qtyCans: Number(a.qtyCans||0)
          };
        });

      const pkFilt = pkAgg.filter(r=>{
        if (fBrand){
          const st = STYLES.find(s=>String(s.id)===String(r.styleId));
          if (!st || String(st.brandId)!==String(fBrand)) return false;
        }
        if (fStyle && String(r.styleId)!==String(fStyle)) return false;
        return true;
      });

      pkFilt.sort((a,b)=>{
        if (a.brandName!==b.brandName) return a.brandName.localeCompare(b.brandName);
        if (a.styleName!==b.styleName) return a.styleName.localeCompare(b.styleName);
        return a.type.localeCompare(b.type);
      });

      const tbP = byId("pk_packages_table").querySelector("tbody");
      tbP.innerHTML = "";
      let totBoxes=0, totCans=0;
      for (const r of pkFilt){
        totBoxes += r.boxes; totCans += r.qtyCans;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.brandName}</td>
          <td>${r.styleName}</td>
          <td>${friendlyType(r.type)}</td>
          <td class="text-end">${fmtInt(r.boxes)}</td>
          <td class="text-end">${fmtInt(r.qtyCans)}</td>
        `;
        tbP.appendChild(tr);
      }
      byId("pk_boxes_total").textContent = fmtInt(totBoxes);
      byId("pk_boxes_cans_total").textContent = fmtInt(totCans);
    }

    // CSV export sencillos
    function toCSV(rows, headers){
      const esc = v => {
        let s = v==null ? "" : String(v);
        if (/[",\n]/.test(s)) s = '"' + s.replace(/"/g,'""') + '"';
        return s;
      };
      const lines = [headers.join(",")].concat(
        rows.map(r => headers.map(h => esc(r[h])).join(","))
      );
      return lines.join("\n");
    }
    function download(name, content){
      const blob = new Blob([content], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download=name;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
    }

    function exportCansCSV(){
      // Reusar los datos ya agregados, sin filtros para exportar todo
      const rows = aggregateCans().map(a=>{
        const st = STYLES.find(s=>String(s.id)===String(a.styleId));
        const br = BRANDS.find(b=>String(b.id)===String(st?.brandId||""));
        return {
          brand: br?.name || "",
          style: st?.name || "",
          state: a.state,
          qty: Number(a.qty||0)
        };
      });
      const csv = toCSV(rows, ["brand","style","state","qty"]);
      download(`stock_latas_${Date.now()}.csv`, csv);
    }
    function exportPackagesCSV(){
      const rows = aggregatePackages().map(a=>{
        const st = STYLES.find(s=>String(s.id)===String(a.styleId));
        const br = BRANDS.find(b=>String(b.id)===String(st?.brandId||""));
        return {
          brand: br?.name || "",
          style: st?.name || "",
          type: friendlyType(a.type),
          boxes: Number(a.boxes||0),
          cans: Number(a.qtyCans||0)
        };
      });
      const csv = toCSV(rows, ["brand","style","type","boxes","cans"]);
      download(`stock_paquetes_${Date.now()}.csv`, csv);
    }

    // Cargar datos y render
    async function loadAll(){
      // usa apiGet de app.js
      [BRANDS, STYLES, CANS, PACKS] = await Promise.all([
        apiGet("brands"),
        apiGet("styles"),
        apiGet("cans"),
        apiGet("packages")
      ]);
      loadFilters();
      renderCards();
      renderTables();
    }

    // Eventos
    document.addEventListener("DOMContentLoaded", ()=>{
      const b = byId("pk_btn_refresh");
      b?.addEventListener("click", async ()=>{
        b.disabled = true;
        b.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>Actualizar`;
        try { await loadAll(); } finally {
          b.disabled = false; b.textContent = "Actualizar";
        }
      });

      byId("pk_filter_brand").addEventListener("change", ()=>{
        renderCards(); renderTables();
      });
      byId("pk_filter_style").addEventListener("change", ()=>{
        renderCards(); renderTables();
      });

      byId("pk_cans_csv").addEventListener("click", exportCansCSV);
      byId("pk_packages_csv").addEventListener("click", exportPackagesCSV);
    });

    // Bootstrap: primera carga
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", loadAll);
    } else {
      loadAll();
    }
  })();
  </script>
</body>
</html>
